/*! mythling-epg v1.2.0
 *  Copyright 2015 Donald Oakes
 *  License: Apache-2.0 */
"use strict";function urlParams(){for(var a,b={},c=/([^&=]+)=?([^&]*)/g;null!==(a=c.exec(window.location.search.substring(1)));)b[decodeURIComponent(a[1])]=decodeURIComponent(a[2]);return b}function parseCssDim(a){return a.endsWith("px")&&(a=a.substring(0,a.lastIndexOf("px"))),parseInt(a)}function parseCssDim(a){return a.endsWith("px")&&(a=a.substring(0,a.lastIndexOf("px"))),parseInt(a)}function scrollHandler(){sl=window.pageXOffset,sl!=oldSl&&(timeslotRowF.style.visibility="hidden",timeslotRowA.style.visibility="visible",channelColA.style.visibility="hidden",channelColF.style.visibility="visible",timeslotRowF.style.left=labelWidth-sl+"px",channelColA.style.left=sl+"px",oldSl=sl,setPosition(sl)),st=window.pageYOffset,st!=oldSt&&(channelColF.style.visibility="hidden",channelColA.style.visibility="visible",timeslotRowA.style.visibility="hidden",timeslotRowF.style.visibility="visible",channelColF.style.top=headerHeight-st+"px",timeslotRowA.style.top=st+"px",oldSt=st)}var epgApp=angular.module("epgApp",["epgSearch","epgCalendar","infinite-scroll","stay","ui.bootstrap"]);epgApp.constant("ERROR_TAG","ERROR: "),epgApp.config(["$compileProvider",function(a){var b="true"==urlParams().angularDebug;a.debugInfoEnabled(b)}]),epgApp.config(["$httpProvider",function(a){a.defaults.headers.get={Accept:"application/json"},a.interceptors.push(function(){return{request:function(a){return a.requestTimestamp=(new Date).getTime(),a},response:function(a){return a.config.responseTime=(new Date).getTime()-a.config.requestTimestamp,a}}})}]),epgApp.config(["$tooltipProvider",function(a){a.setTriggers({popShow:"popHide"})}]),epgApp.controller("EpgController",["$scope","$window","$http","$timeout","$location","$modal","$filter","GuideData",function(a,b,c,d,e,f,g,h){console.log("userAgent: "+b.navigator.userAgent),console.log("location: "+b.location);for(var i=0;i<b.document.styleSheets.length;i++){var j=b.document.styleSheets[i];if(null!==j.href&&j.href.endsWith("mythling.css"))for(var k=0;k<j.cssRules.length;k++){var l=j.cssRules[k];".slot-width"===l.selectorText?a.slotWidth=parseCssDim(l.style.width):".header-height"===l.selectorText?a.headerHeight=parseCssDim(l.style.height):".label-width"===l.selectorText?a.labelWidth=parseCssDim(l.style.width):".row-height"===l.selectorText&&(a.rowHeight=parseCssDim(l.style.height))}}var m=urlParams(),n=m.startTime?new Date(m.startTime):new Date;n=m.StartTime?new Date(m.StartTime):n,console.log("startTime: "+n);var o=m.guideInterval?parseInt(m.guideInterval):12,p=m.guideHistory?parseInt(m.guideHistory):0;a.bufferSize=m.bufferSize?parseInt(m.bufferSize):6;var q=m.awaitPrime?"true"==m.awaitPrime:!1,r=m.channelGroupId?parseInt(m.channelGroupId):0,s=m.mythlingServices?"true"==m.mythlingServices:!1,t=m.demoMode?"true"==m.demoMode:!1;a.guideData=new h(n,a.slotWidth,o,q,p,r,s,t),a.setPosition=function(b){var c=Math.floor(b/a.slotWidth),d=new Date(a.guideData.zeroTime.getTime()+18e5*c);d.getTime()!=a.guideData.curDate.getTime()&&(a.guideData.curDate=d,a.guideData.busy||angular.element(document.getElementById("calendarInput")).val(g("date")(a.guideData.curDate,"EEE MMM d")))},setPosition=a.setPosition,a.popElem=null,a.setPopElem=function(b){a.popElem=b,b.children(0).addClass("program-select")},a.popHide=function(){null!==a.popElem&&(a.popElem.triggerHandler("popHide"),a.popElem.children(0).removeClass("program-select"),a.popElem=null)},a.popPlace="top",a.setPopPlace=function(b){a.popPlace=b};var u=angular.element(b);u.bind("click",a.popHide),u.bind("scroll",a.popHide),u.bind("resize",a.popHide),a.details=function(b){if(d(function(){angular.element(document.getElementById(b.id)).addClass("program-select")},0),!a.guideData.demoMode&&a.guideData.isMyth28){var e="/Guide/GetProgramDetails?ChanId="+b.channel.ChanId+"&StartTime="+b.StartTime;console.log("details url: "+e),c.get(e).success(function(c){var d=c.Program;if(d.Description&&(b.description=d.Description.replace("``",'"')),d.Airdate&&"true"===d.Repeat){var e=d.Airdate,g=new Date;g.setFullYear(parseInt(e.substring(0,e.indexOf("-")))),g.setMonth(parseInt(e.substring(e.indexOf("-")+1,e.lastIndexOf("-")))-1),g.setDate(parseInt(e.substring(e.lastIndexOf("-")+1))),g.setHours(0),g.setMinutes(0),g.setSeconds(0),g.setMilliseconds(0),b.originalAirDate=g}if(d.Category&&(b.category=d.Category),d.Season&&"0"!=d.Season&&(b.season=parseInt(d.Season)),d.Episode&&"0"!=d.Episode&&(b.episode=parseInt(d.Episode)),d.Stars&&"0"!=d.Stars&&(b.rating=Math.round(5*parseFloat(d.Stars))),d.Cast&&d.Cast.CastMembers){for(var h="",i="",j=0;j<d.Cast.CastMembers.length;j++){var k=d.Cast.CastMembers[j];"director"==k.Role?h+=k.Name+", ":("actor"==k.Role||"guest_star"==k.Role)&&(i+=k.Name+", ")}""!==h&&(b.directors=h.substring(0,h.length-2)),""!==i&&(b.actors=i.substring(0,i.length-2))}a.program=b;f.open({animation:!1,templateUrl:"views/details.html",controller:"EpgModalController",scope:a})})}else{a.program=b;f.open({animation:!1,templateUrl:"views/details.html",controller:"EpgModalController",scope:a})}},a.fireEpgAction=function(a){"function"==typeof CustomEvent&&document.dispatchEvent(new CustomEvent("epgAction",{name:a}))},0===a.bufferSize&&a.guideData.nextPage()}]),epgApp.controller("EpgModalController",["$scope","$timeout","$modalInstance",function(a,b,c){a.close=function(a){b(function(){var b=document.getElementById(a.id);angular.element(b).removeClass("program-select"),b.focus()},0),c.dismiss("close")}}]),epgApp.directive("popClick",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){if(b.popElem!=c){var d=c[0].getBoundingClientRect(),e=d.top,f=document.documentElement.clientHeight-d.bottom,g=d.left,h=document.documentElement.clientWidth-d.right,i=120>e,j=120>f,k=155>g,l=155>h,m=g+c[0].offsetWidth/2<80,n=document.documentElement.clientWidth-d.left-c[0].offsetWidth/2<80,o=(m||n)&&!(m&&n),p="top";(i||o)&&(f>e&&(p="bottom"),(j||o)&&(k&&!l?p="right":l&&!k&&(p="left"))),b.setPopPlace(p),b.$apply(),a(function(){null===b.popElem&&(c.triggerHandler("popShow"),b.setPopElem(c))},0)}})}}}]),epgApp.directive("onEnter",function(){return{restrict:"A",link:function(a,b,c){b.bind("keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.onEnter)}),b.preventDefault())})}}}),epgApp.directive("focusMe",function(){var a={};return{restrict:"A",link:function(b,c,d){"later"==d.focusMe?a[c[0].id]?c[0].focus():a[c[0].id]=!0:c[0].focus()}}}),epgApp.directive("blurMe",function(){return{restrict:"A",link:function(a,b,c){b.bind("focus",function(){b[0].blur()})}}}),epgApp.directive("epgRecord",["$http",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){var c=d.epgRecord,e="/Dvr/";"single"==c||"transcode"==c||"all"==c?e+="AddRecordSchedule?ChanId="+b.program.channel.ChanId+"&Station="+b.program.channel.CallSign+"&StartTime="+b.program.StartTime+"&EndTime="+b.program.EndTime+"&Type="+("transcode"==c?"single":c)+"&Title="+encodeURI(b.program.Title)+"&FindDay=0&FindTime=00:00:00":("dont"==c||"never"==c)&&(e+="AddDontRecordSchedule?ChanId="+b.program.channel.ChanId+"&StartTime="+b.program.StartTime+"&NeverRecord="+("never"==c)),"transcode"==c&&(e+="&AutoTranscode=true"),b.fireEpgAction("record"),console.log("record action url: "+e),b.guideData.demoMode?b.program.willRecord="single"==c||"transcode"==c||"all"==c:a.post(e).success(function(a,d,e,f){b.program.willRecord="single"==c||"transcode"==c||"all"==c})})}}}]),epgApp.factory("GuideData",["$http","$timeout","$window","$filter","ERROR_TAG",function(a,b,c,d,e){var f=function(a,b,c,d,e,f,g,h){this.slotWidth=b,this.interval=36e5*c,this.history=36e5*e,f&&(this.channelGroupId=f),this.busy=!1,this.prescrolled=!1,this.preventMobileScroll=function(a){a.preventDefault()},this.setStartTime(a),this.awaitPrime=d,this.mythlingServices=g,this.demoMode=h};return f.prototype.setStartTime=function(a){console.log("startTime: "+a.toISOString()),this.curDate=new Date(a),this.channels={},this.startTime=new Date(a),this.startTime.setTime(this.startTime.getTime()-this.history),this.startTime.setMinutes(this.startTime.getMinutes()>=30?30:0),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0),this.endTime=new Date(this.startTime.getTime()+this.interval),this.zeroTime=new Date(this.startTime),this.timeslots=[],this.index=10},f.prototype.nextPage=function(f,g){if(!this.busy){this.busy=!0,g&&null!==g&&(this.endTime=new Date(this.startTime.getTime()+864e5));for(var h=this.startTime.toISOString(),i=this.endTime.toISOString(),j=this.startTime.getTime();j<this.endTime.getTime();j+=18e5){var k=new Date(j),l=k.getHours(),m=l>=12?" pm":" am";0===l?l=12:l>12&&(l-=12),m=l+":"+(0===k.getMinutes()?"00":"30")+m,this.timeslots.push(m)}var n;n=this.demoMode?"demo/guide-data/":this.mythlingServices?"/mythling/media.php?type=guide&":"/Guide/GetProgramGuide?";var o="StartTime="+h+"&EndTime="+i;this.channelGroupId&&this.channelGroupId>0&&(o+="&ChannelGroupId="+this.channelGroupId),n+=this.demoMode?o.replace(/:/g,"-")+".json":o,console.log("retrieving from: "+n),this.awaitPrime&&angular.element(document.body).bind("touchmove",this.preventMobileScroll);var p=angular.element(document.getElementById("calendarInput"));p.addClass("input-warn"),p.val("Loading..."),b(function(){p.val("Loading...")},75),a.get(n).error(function(a,b){console.log(e+"HTTP "+b+": "+n),this.busy=!1}).success(function(a,e,h,i){console.log("guide data response time: "+i.responseTime),"undefined"==typeof this.isMyth28&&(this.mythVersion=a.ProgramGuide.Version?a.ProgramGuide.Version:"0.27",console.log("MythTV version "+this.mythVersion),this.isMyth28=!this.mythVersion.startsWith("0.27"));for(var j=a.ProgramGuide.Channels,k=0,l=0;l<j.length;l++){var m=j[l];if(m.Programs.length>0){k++;for(var n=m.ChanNum;n.length<4;)n="0"+n;n in this.channels||(m.programs={},m.progSize=0,m.progOffset=0,this.channels[n]=m);for(var o=this.channels[n],q=0;q<m.Programs.length;q++){var r=m.Programs[q],s=new Date(r.EndTime);if(s.getTime()>this.startTime.getTime()-this.history){var t=r.StartTime;if(!(t in o.programs)){o.programs[t]=r,o.progSize++;var u=new Date(r.StartTime),v=u.getTime()<this.startTime.getTime()?this.startTime.getTime():u.getTime(),w=(s.getTime()-v)/18e5;r.start=u,r.end=s,r.offset=o.progOffset,r.width=Math.round(this.slotWidth*w),r.subTitle=r.SubTitle?'"'+r.SubTitle+'"':"",r.willRecord="-1"==r.Recording.Status||"-2"==r.Recording.Status||"-3"==r.Recording.Status||"WillRecord"==r.Recording.Status||"Recording"==r.Recording.Status||"Recorded"==r.Recording.Status,r.channel=o,r.id="ch"+o.ChanId+"pr"+r.StartTime,r.seq="ch"+k+"pr"+o.progSize,r.index=this.index++,o.progOffset+=r.width}}}}}if(g&&null!==g){var x=(g.getTime()-this.startTime.getTime())*this.slotWidth/18e5;b(function(){c.scrollTo(x,0)},0)}if(this.startTime.setTime(this.endTime.getTime()),this.endTime.setTime(this.endTime.getTime()+this.interval),!this.prescrolled){this.prescrolled=!0;var y=this.history*this.slotWidth/18e5;b(function(){c.scrollBy(y,0)},0)}if(f&&null!==f&&b(function(){console.log("selecting program: "+f),document.getElementById(f).focus()},0),this.awaitPrime){var z=this.preventMobileScroll;b(function(){angular.element(document.body).unbind("touchmove",z)},0)}p.removeClass("input-warn"),p.val(d("date")(this.curDate,"EEE MMM d")),this.busy=!1}.bind(this))}},f}]);var setPosition;"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)});for(var stayOmbMod=angular.module("stay",[]),labelWidth=105,headerHeight=50,i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];if(null!==sheet.href&&sheet.href.endsWith("mythling.css"))for(var j=0;j<sheet.cssRules.length;j++){var rule=sheet.cssRules[j];".header-height"===rule.selectorText?headerHeight=parseCssDim(rule.style.height):".label-width"===rule.selectorText&&(labelWidth=parseCssDim(rule.style.width))}}var timeslotRowA,channelColA,timeslotRowF,channelColF,sl,oldSl=0,st,oldSt=0;document.addEventListener("DOMContentLoaded",function(a){timeslotRowA=document.getElementById("timeslot-row-a"),channelColA=document.getElementById("channel-column-a"),timeslotRowF=document.getElementById("timeslot-row-f"),channelColF=document.getElementById("channel-column-f")}),window.onscroll=function(){scrollHandler()};var epgCalendar=angular.module("epgCalendar",[]);epgCalendar.controller("EpgCalController",["$scope","$timeout",function(a,b){a.minDate=new Date,a.maxDate=new Date(a.minDate.getTime()+12096e5),a.openCalendar=function(c){c.preventDefault(),c.stopPropagation(),a.calendarOpened?a.calendarOpened=!1:a.calendarOpened=!0,null!==a.popElem&&b(function(){a.popHide()},0)},a.currentDate=function(b){if(b){var c=new Date(b),d=new Date(c);d.setHours(0),d.setMinutes(0),a.guideData.setStartTime(d),a.fireEpgAction("calendar"),a.guideData.nextPage(null,c)}return a.guideData.curDate}}]);var epgSearch=angular.module("epgSearch",[]);epgSearch.controller("EpgSearchController",["$scope","$timeout","search",function(a,b,c){a.filterVal="",a.searchOpened=!1,a.searchClick=function(b){a.searchOpened=!a.searchOpened},a.searchForward=function(){a.resultsSummary=null,c.forward(a.filterVal,a.guideData.curDate,a.showResult)},a.searchBackward=function(){a.resultsSummary=null,c.backward(a.filterVal,a.guideData.curDate,a.showResult)},a.showResult=function(b){if(a.resultsSummary=b.index+1+" / "+b.programs.length,b.programs.length>0){var c=b.programs[b.index],d=new Date(c.start);d.setMinutes(0),a.guideData.setStartTime(d),a.guideData.nextPage(c.id)}},a.isSearching=function(){return c.isBusy()},a.closeSearch=function(){b(function(){a.fireEpgAction("search"),document.getElementById("searchBtn").click()},5)},a.searchFilter=function(b){if(b||""===b)a.filterVal=b;else{if(!a.guideData.isMyth28)return"Search requires MythTV 0.28";if(a.guideData.demoMode)return"Search not available in demo"}return a.filterVal}}]),epgSearch.factory("search",["$http","$q",function(a,b){function c(c,g,h){e=!0,f.index=-1,f.programs=[],d=c;var i=new Date,j="/Guide/GetProgramList?StartTime="+i.toISOString();console.log("search base url: "+j),b.all({personSearch:a.get(j+"&PersonFilter="+d),keywordSearch:a.get(j+"&KeywordFilter="+d)}).then(function(a){if(e=!1,f.addPrograms(a.personSearch.data.ProgramList.Programs),f.addPrograms(a.keywordSearch.data.ProgramList.Programs),f.programs.length>0){f.index=0;var b=f.programs[f.index],c=new Date(g.getTime());for(c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0);b.start.getTime()<c.getTime();)f.index++,b=f.programs[f.index]}h(f)})}var d,e=!1,f={index:-1,programs:[],addPrograms:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.hasProgram(c)||(c.start=new Date(c.StartTime),c.id="ch"+c.Channel.ChanId+"pr"+c.StartTime,this.programs.push(c))}},hasProgram:function(a){for(var b=0;b<this.programs.length;b++){var c=this.programs[b];if(c.ChanId==a.ChanId&&c.StartTime==a.StartTime)return!0}}};return{forward:function(a,b,e){if(a&&""!==a){var g=encodeURIComponent(a);g!=d&&c(g,b,e),f.programs.length>0&&(f.index++,f.index==f.programs.length&&(f.index=0),e(f))}},backward:function(a,b,e){if(a&&""!==a){var g=encodeURIComponent(a);g!=d&&c(g,b,e),f.programs.length>0&&(f.index--,-1==f.index&&(f.index=f.programs.length-1),e(f))}},isBusy:function(){return e},getResults:function(){return f}}}]),epgSearch.directive("searchPreRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){a(function(){c[0].click(),c[0].click()},5)}}}]);