/*! mythling-epg v1.2.1
 *  Copyright 2015 Donald Oakes
 *  License: Apache-2.0 */
"use strict";function urlParams(){for(var a,b={},c=/([^&=]+)=?([^&]*)/g;null!==(a=c.exec(window.location.search.substring(1)));)b[decodeURIComponent(a[1])]=decodeURIComponent(a[2]);return b}function parseCssDim(a){return a.endsWith("px")&&(a=a.substring(0,a.lastIndexOf("px"))),parseInt(a)}var epgApp=angular.module("epgApp",["epgSearch","epgCalendar","infinite-scroll","stay","ui.bootstrap"]);epgApp.constant("ERROR_TAG","ERROR: "),epgApp.value("RECORD_STATUSES",[{status:"Failing",code:-14,record:!1,error:!0,description:"Failing",actions:["dont","never","remove"]},{status:"MissedFuture",code:-11,record:!1,error:!0,description:"Missed Future",actions:["dont","never","remove"]},{status:"Tuning",code:-10,record:!0,error:!1,description:"Tuning",actions:["dont","never","remove"]},{status:"Failed",code:-9,record:!1,error:!0,description:"Failed",actions:["dont","never","remove"]},{status:"TunerBusy",code:-8,record:!1,error:!0,description:"Tuner Busy",actions:["dont","never","remove"]},{status:"LowDiskSpace",code:-7,record:!1,error:!0,description:"Low Disk Space",actions:["dont","never","remove"]},{status:"Cancelled",code:-6,record:!1,error:!1,description:"Cancelled",actions:["dont","never","remove"]},{status:"Missed",code:-5,record:!1,error:!1,description:"Missed",actions:["dont","never","remove"]},{status:"Aborted",code:-4,record:!1,error:!1,description:"Aborted",actions:["dont","never","remove"]},{status:"Recorded",code:-3,record:!0,error:!1,description:"Recorded",actions:["dont","never","remove"]},{status:"Recording",code:-2,record:!0,error:!1,description:"Recording",actions:["dont","never","remove"]},{status:"WillRecord",code:-1,record:!0,error:!1,description:"Will Record",actions:["dont","never","remove"]},{status:"Unknown",code:0,record:!1,error:!1,description:"",actions:["single","transcode","all"]},{status:"DontRecord",code:1,record:!1,error:!1,description:"Don't Record",actions:["single","transcode","all"]},{status:"PreviousRecording",code:2,record:!1,error:!1,description:"Previous Recording",actions:["single","transcode","remove"]},{status:"CurrentRecording",code:3,record:!1,error:!1,description:"Current Recording",actions:["single","transcode","remove"]},{status:"EarlierShowing",code:4,record:!1,error:!1,description:"Earlier Showing",actions:["single","transcode","remove"]},{status:"TooManyRecordings",code:5,record:!1,error:!1,description:"Too Many Recordings",actions:["single","transcode","remove"]},{status:"NotListed",code:6,record:!1,error:!0,description:"Not Listed",actions:[]},{status:"Conflict",code:7,record:!1,error:!1,description:"Conflict",actions:["dont","never","remove"]},{status:"LaterShowing",code:8,record:!1,error:!1,description:"Later Showing",actions:["dont","never","remove"]},{status:"Repeat",code:9,record:!1,error:!1,description:"Repeat",actions:["dont","never","remove"]},{status:"Inactive",code:10,record:!1,error:!1,description:"Inactive",actions:["single","transcode","all"]},{status:"NeverRecord",code:11,record:!1,error:!1,description:"Never Record",actions:["single","transcode","all"]},{status:"Offline",code:12,record:!1,error:!0,description:"Recorder Offline",actions:[]}]),epgApp.config(["$compileProvider",function(a){var b="true"==urlParams().epgDebug;a.debugInfoEnabled(b)}]),epgApp.config(["$httpProvider",function(a){a.defaults.headers.get={Accept:"application/json"},a.interceptors.push(function(){return{request:function(a){return a.requestTimestamp=(new Date).getTime(),a},response:function(a){return a.config.responseTime=(new Date).getTime()-a.config.requestTimestamp,a}}})}]),epgApp.config(["$tooltipProvider",function(a){a.setTriggers({popShow:"popHide"})}]),epgApp.controller("EpgController",["$scope","$window","$http","$timeout","$location","$modal","$filter","GuideData","RECORD_STATUSES",function(a,b,c,d,e,f,g,h,i){for(var j=0;j<b.document.styleSheets.length;j++){var k=b.document.styleSheets[j];if(null!==k.href&&k.href.endsWith("mythling.css"))for(var l=0;l<k.cssRules.length;l++){var m=k.cssRules[l];".slot-width"===m.selectorText?a.slotWidth=parseCssDim(m.style.width):".header-height"===m.selectorText?a.headerHeight=parseCssDim(m.style.height):".label-width"===m.selectorText?a.labelWidth=parseCssDim(m.style.width):".row-height"===m.selectorText&&(a.rowHeight=parseCssDim(m.style.height))}}var n=urlParams(),o=n.startTime?new Date(n.startTime):new Date;o=n.StartTime?new Date(n.StartTime):o;var p=n.guideInterval?parseInt(n.guideInterval):12,q=n.guideHistory?parseInt(n.guideHistory):0;a.bufferSize=n.bufferSize?parseInt(n.bufferSize):8;var r=n.awaitPrime?"true"==n.awaitPrime:!1,s=n.channelGroupId?parseInt(n.channelGroupId):0;a.showChannelIcons=n.showChannelIcons?"true"==n.showChannelIcons:!1;var t=(n.recordingPriority?n.recordingPriority:0,n.mythlingServices?"true"==n.mythlingServices:!1),u=n.demoMode?"true"==n.demoMode:!1;a.revertLabelsToFixed=n.revertLabelsToFixed?parseInt(n.revertLabelsToFixed):0,epgDebug=n.epgDebug?"true"==n.epgDebug:!1,epgDebug&&(console.log("userAgent: "+b.navigator.userAgent),console.log("location: "+b.location),console.log("startTime: "+o)),a.guideData=new h(o,a.slotWidth,p,r,q,s,t,u),a.recordStatus=function(a){var b=parseInt(a);if(isNaN(b)){for(var c=0;c<i.length;c++)if(i[c].status==a)return i[c]}else for(var d=0;d<i.length;d++)if(i[d].code==b)return i[d]},a.setPosition=function(b){var c=Math.floor(b/a.slotWidth),d=new Date(a.guideData.beginTime.getTime()+18e5*c);d.getTime()!=a.guideData.curDate.getTime()&&(a.guideData.curDate=d,a.guideData.busy||angular.element(document.getElementById("calendarInput")).val(g("date")(a.guideData.curDate,"EEE MMM d")))},setPosition=a.setPosition,a.popElem=null,a.setPopElem=function(b){a.popElem=b,b.children(0).addClass("program-select")},a.popHide=function(){null!==a.popElem&&(a.popElem.triggerHandler("popHide"),a.popElem.children(0).removeClass("program-select"),a.popElem=null,a.fireEpgAction("close.menu"))},popHide=a.popHide,a.popPlace="top",a.setPopPlace=function(b){a.popPlace=b},a.details=function(b){if(d(function(){angular.element(document.getElementById(b.id)).addClass("program-select")},0),a.fireEpgAction("open.details"),a.guideData.demoMode){a.program=b;var e=f.open({animation:!1,templateUrl:"views/details.html",controller:"EpgModalController",scope:a});return void e.result["catch"](function(){d(function(){var c=document.getElementById(b.id);angular.element(c).removeClass("program-select"),c.focus(),a.fireEpgAction("close.details")},0)})}var g="/Guide/GetProgramDetails?ChanId="+b.channel.ChanId+"&StartTime="+b.StartTime;epgDebug&&console.log("details url: "+g),c.get(g).success(function(c){var e=c.Program;if(e.Description&&(b.description=e.Description.replace("``",'"')),b.repeat="true"===e.Repeat,b.isMovie="movie"===e.CatType,e.Airdate){var g=e.Airdate,h=new Date;h.setFullYear(parseInt(g.substring(0,g.indexOf("-")))),h.setMonth(parseInt(g.substring(g.indexOf("-")+1,g.lastIndexOf("-")))-1),h.setDate(parseInt(g.substring(g.lastIndexOf("-")+1))),h.setHours(0),h.setMinutes(0),h.setSeconds(0),h.setMilliseconds(0),b.aired=h}if(e.Category&&(b.category=e.Category),e.Season&&"0"!=e.Season&&(b.season=parseInt(e.Season)),e.Episode&&"0"!=e.Episode&&(b.episode=parseInt(e.Episode)),e.Stars&&"0"!=e.Stars&&(b.rating=Math.round(5*parseFloat(e.Stars))),e.Cast&&e.Cast.CastMembers){for(var i="",j="",k=0;k<e.Cast.CastMembers.length;k++){var l=e.Cast.CastMembers[k];"director"==l.Role?i+=l.Name+", ":("actor"==l.Role||"guest_star"==l.Role)&&(j+=l.Name+", ")}""!==i&&(b.directors=i.substring(0,i.length-2)),""!==j&&(b.actors=j.substring(0,j.length-2))}if(e.Recording&&e.Recording.Status){var m=parseInt(e.Recording.Status);b.recStatus=a.recordStatus(m)}a.program=b;var n=f.open({animation:!1,templateUrl:"views/details.html",controller:"EpgModalController",scope:a});n.result["catch"](function(){d(function(){var c=document.getElementById(b.id);angular.element(c).removeClass("program-select"),c.focus(),a.fireEpgAction("close.details")},0)})})},a.fireEpgAction=function(a){"function"==typeof CustomEvent&&epgDebug&&console.log("firing epgAction: "+a),document.dispatchEvent(new CustomEvent("epgAction",{detail:a}))},0===a.bufferSize&&a.guideData.nextPage()}]),epgApp.controller("EpgModalController",["$scope","$timeout","$modalInstance",function(a,b,c){a.close=function(a){c.dismiss("close")}}]),epgApp.directive("popContainer",["$window",function(a){return{restrict:"A",link:function(b,c,d){var e=angular.element(a);e.bind("click",b.popHide),e.bind("scroll",b.popHide),e.bind("resize",b.popHide),b.$on("$destroy",function(){e.unbind("click",b.popHide),e.unbind("scroll",b.popHide),e.unbind("resize",b.popHide)})}}}]),epgApp.directive("popClick",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){var e=function(){if(b.popElem!=c){var d=c[0].getBoundingClientRect(),e=d.top,f=document.documentElement.clientHeight-d.bottom,g=d.left,h=document.documentElement.clientWidth-d.right,i=120>e,j=120>f,k=155>g,l=155>h,m=g+c[0].offsetWidth/2<80,n=document.documentElement.clientWidth-d.left-c[0].offsetWidth/2<80,o=(m||n)&&!(m&&n),p="top";(i||o)&&(f>e&&(p="bottom"),(j||o)&&(k&&!l?p="right":l&&!k&&(p="left"))),b.setPopPlace(p),b.$apply(),a(function(){null===b.popElem&&(c.triggerHandler("popShow"),b.setPopElem(c),b.fireEpgAction("open.menu"))},0)}},f=function(a){13===a.which?(a.preventDefault(),b.popElem===c?popHide():e()):27===a.which&&b.popElem===c&&(a.preventDefault(),popHide())};c.bind("click",e),c.bind("keyup",f),b.$on("$destroy",function(){c.unbind("click",e),c.unbind("keyup",f)})}}}]),epgApp.directive("popHide",["$timeout",function(a){return{restrict:"A",link:function(a,b,c){var d=function(b){a.popHide()};b.bind("blur",d),a.$on("$destroy",function(){b.unbind("blur",d)})}}}]),epgApp.directive("onEnter",function(){return{restrict:"A",link:function(a,b,c){var d=function(b){13===b.which&&(a.$apply(function(){a.$eval(c.onEnter)}),b.preventDefault())};b.bind("keypress",d),a.$on("$destroy",function(){b.unbind("click",d)})}}}),epgApp.directive("focusMe",function(){var a={};return{restrict:"A",link:function(b,c,d){"later"==d.focusMe?a[c[0].id]?c[0].focus():a[c[0].id]=!0:c[0].focus()}}}),epgApp.directive("blurMe",function(){return{restrict:"A",link:function(a,b,c){var d=function(){b[0].blur()};b.bind("focus",d),a.$on("$destroy",function(){b.unbind("focus",d)})}}}),epgApp.directive("epgRecord",["$http","$timeout","ERROR_TAG","RECORD_STATUSES",function(a,b,c,d){return{restrict:"A",link:function(e,f,g){var h=function(){var f=g.epgRecord,h="/Dvr/";"single"==f||"transcode"==f||"all"==f?h+="AddRecordSchedule?ChanId="+e.program.channel.ChanId+"&Station="+e.program.channel.CallSign+"&StartTime="+e.program.StartTime+"&EndTime="+e.program.EndTime+"&Type="+("transcode"==f?"single":f)+"&Title="+encodeURI(e.program.Title)+"&FindDay=0&FindTime=00:00:00":"dont"==f||"never"==f?h+="AddDontRecordSchedule?ChanId="+e.program.channel.ChanId+"&StartTime="+e.program.StartTime:"remove"==f&&(h+="GetRecordSchedule?ChanId="+e.program.channel.ChanId+"&StartTime="+e.program.StartTime),"never"==f&&(h+="NeverRecord=true"),"transcode"==f&&(h+="&AutoTranscode=true"),epgDebug&&console.log("record action url: "+h),e.guideData.demoMode?"single"==f||"transcode"==f||"all"==f?e.program.recStatus=d[11]:e.program.recStatus=d[12]:a.post(h).success(function(g,i,j,k){if("remove"==f){var l=g.RecRule.Id;h="/Dvr/RemoveRecordSchedule?RecordId="+l,epgDebug&&console.log("remove recording schedule url: "+h),a.post(h).success(function(f,g,i,j){b(function(){var b="/Dvr/GetUpcomingList?ShowAll=true";a.get(b).success(function(a,b,c,f){epgDebug&&console.log("upcoming list response time: "+f.responseTime);for(var g=a.ProgramList.Programs,h=[],i=0;i<g.length;i++)g[i].Title==e.program.Title&&h.push(g[i]);for(var j in e.guideData.channels)for(var k in e.guideData.channels[j].programs){var l=e.guideData.channels[j].programs[k];if(l.Title==e.program.Title){for(var m=null,n=0;n<h.length;n++){var o=h[n];o.StartTime==l.StartTime&&o.Channel.ChanId==l.channel.ChanId&&(m=o)}null===m?l.recStatus=d[12]:l.recStatus=e.recordStatus(m.Recording.Status)}}}).error(function(a,b){console.log(c+"HTTP "+b+": "+h)})},500)}).error(function(a,b){console.log(c+"HTTP "+b+": "+h)})}else b(function(){var b="/Dvr/GetUpcomingList?ShowAll=true";a.get(b).success(function(a,b,c,d){epgDebug&&console.log("upcoming list response time: "+d.responseTime);for(var f=a.ProgramList.Programs,g=0;g<f.length;g++){var h=f[g];if(h.Title==e.program.Title){var i=e.guideData.getChanNumIndex(h.Channel),j=e.guideData.channels[i];if(j){var k=j.programs[h.StartTime];k&&k.Title==h.Title&&(k.recStatus=e.recordStatus(h.Recording.Status))}}}}).error(function(a,b){console.log(c+"HTTP "+b+": "+h)})},500)}).error(function(a,b){console.log(c+"HTTP "+b+": "+h)})};f.bind("click",h),e.$on("$destroy",function(){f.unbind("click",h)})}}}]),epgApp.factory("GuideData",["$http","$timeout","$window","$filter","ERROR_TAG","RECORD_STATUSES",function(a,b,c,d,e,f){var g=function(a,b,c,d,e,f,g,h){this.slotWidth=b,this.interval=36e5*c,this.history=36e5*e,f&&(this.channelGroupId=f),this.busy=!1,this.prescrolled=!1,this.preventMobileScroll=function(a){a.preventDefault()},this.setStartTime(a),this.zeroTime=new Date(this.startTime),this.awaitPrime=d,this.mythlingServices=g,this.demoMode=h};return g.prototype.setStartTime=function(a){epgDebug&&console.log("startTime: "+a.toISOString()),this.curDate=new Date(a),this.channels={},this.startTime=new Date(a),this.startTime.setTime(this.startTime.getTime()-this.history),this.startTime.setMinutes(this.startTime.getMinutes()>=30?30:0),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0),this.endTime=new Date(this.startTime.getTime()+this.interval),this.beginTime=new Date(this.startTime),this.timeslots=[],this.index=10},g.prototype.nextPage=function(g,h){if(!this.busy){this.busy=!0,h&&null!==h&&(this.endTime=new Date(this.startTime.getTime()+864e5));for(var i=this.startTime.toISOString(),j=this.endTime.toISOString(),k=this.startTime.getTime();k<this.endTime.getTime();k+=18e5){var l=new Date(k),m=l.getHours(),n=m>=12?" pm":" am";0===m?m=12:m>12&&(m-=12),n=m+":"+(0===l.getMinutes()?"00":"30")+n,this.timeslots.push(n)}var o;o=this.demoMode?"demo/guide-data/":this.mythlingServices?"/mythling/media.php?type=guide&":"/Guide/GetProgramGuide?";var p="StartTime="+i+"&EndTime="+j;this.channelGroupId&&this.channelGroupId>0&&(p+="&ChannelGroupId="+this.channelGroupId),o+=this.demoMode?p.replace(/:/g,"-")+".json":p,epgDebug&&console.log("retrieving from: "+o),this.awaitPrime&&angular.element(document.body).bind("touchmove",this.preventMobileScroll);var q=angular.element(document.getElementById("calendarInput"));q.addClass("input-warn"),q.val("Loading..."),b(function(){q.val("Loading...")},75),a.get(o).error(function(a,b){console.log(e+"HTTP "+b+": "+o),this.busy=!1}).success(function(a,e,i,j){epgDebug&&console.log("guide data response time: "+j.responseTime),"undefined"==typeof this.isMyth28&&(this.mythVersion=a.ProgramGuide.Version?a.ProgramGuide.Version:"0.27",epgDebug&&console.log("MythTV version "+this.mythVersion),this.isMyth28=!this.mythVersion.startsWith("0.27"));var k=a.ProgramGuide.Channels,l=this.startTime.getTime()==this.beginTime.getTime();l||this.addMissingChannelsTo(k);for(var m=0,n=0;n<k.length;n++){var o=k[n];if(!l||o.Programs.length>0){m++;var p=this.getChanNumIndex(o);p in this.channels||!l||(o.programs={},o.progSize=0,o.progOffset=0,this.channels[p]=o);var r=this.channels[p];if("undefined"!=typeof r&&null!==r){for(var s=this.startTime,t=0;t<o.Programs.length;t++){var u=o.Programs[t],v=u.StartTime,w=new Date(u.StartTime),x=new Date(u.EndTime);if(x.getTime()>this.startTime.getTime()-this.history&&w.getTime()<this.endTime.getTime()){r.programs[v]=u;var y=w.getTime()<this.beginTime.getTime()?this.startTime.getTime():w.getTime(),z=x.getTime()>this.endTime.getTime()?this.endTime.getTime():x.getTime(),A=(z-y)/18e5;if(y>s.getTime()&&this.addFiller(r,s,new Date(y)),s=x,u.start=w,u.end=x,u.offset=r.progOffset,u.width=Math.round(this.slotWidth*A),u.subTitle=u.SubTitle?'"'+u.SubTitle+'"':"",u.Recording&&u.Recording.Status)for(var B=parseInt(u.Recording.Status),C=0;C<f.length;C++)f[C].code==B&&(u.recStatus=f[C]);u.channel=r,r.progSize++,u.id="ch"+r.ChanId+"pr"+u.StartTime,u.seq="ch"+m+"pr"+r.progSize,u.index=this.index++,r.progOffset+=u.width}}if(this.endTime.getTime()>s.getTime()&&this.addFiller(r,s,this.endTime),l){var D=r.programs[this.startTime.toISOString()];if(D&&D.filler){var E={Title:"",SubTitle:"",channel:r};E.width=0,r.programs[this.startTime.toISOString()]=E,r.programs[new Date(this.startTime.getTime()+1e3).toISOString()]=D}}}}}if(h&&null!==h){var F=(h.getTime()-this.startTime.getTime())*this.slotWidth/18e5;b(function(){c.scrollTo(F,0)},0)}if(this.startTime.setTime(this.endTime.getTime()),this.endTime.setTime(this.endTime.getTime()+this.interval),!this.prescrolled){this.prescrolled=!0;var G=this.history*this.slotWidth/18e5;b(function(){c.scrollBy(G,0)},0)}if(g&&null!==g&&b(function(){epgDebug&&console.log("selecting program: "+g),document.getElementById(g).focus()},0),this.awaitPrime){var H=this.preventMobileScroll;b(function(){angular.element(document.body).unbind("touchmove",H)},0)}q.removeClass("input-warn"),q.val(d("date")(this.curDate,"EEE MMM d")),this.busy=!1}.bind(this))}},g.prototype.getChanNumIndex=function(a){var b=a.ChanNum;for(b.indexOf("_")>=0||b.indexOf(".")>=0?b=b.replace(/[\._]/,""):b+="0";b.length<5;)b="0"+b;for(var c=a.ChanId;c.length<5;)c="0"+c;return b+"_"+c},g.prototype.addMissingChannelsTo=function(a){for(var b in this.channels){for(var c=!1,d=0;d<a.length;d++)if(a[d].ChanNum==this.channels[b].ChanNum){c=!0;break}c||a.push(this.channels[b])}},g.prototype.addFiller=function(a,b,c){console.log(e+"Missing Data for Channel "+a.ChanNum+": "+b+" -> "+c);var d=b.toISOString();a.progSize++;var f={filler:!0,offset:a.progOffset,Title:"",SubTitle:"",channel:a};return f.width=Math.round((c.getTime()-b.getTime())*this.slotWidth/18e5),a.progOffset+=f.width,a.programs[d]=f,f},g}]);var epgDebug,setPosition,popHide;"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)});var stayMod=angular.module("stay",[]);stayMod.directive("stay",["$window","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){function f(){"absolute"==d.css("position")&&("left"==e.stay?(d.css("position","fixed"),d.css("top",h-k+"px"),d.css("left","0px")):"top"==e.stay&&(d.css("position","fixed"),d.css("left",h-i+"px"),d.css("top","0px")))}var g,h,i=0,j=0,k=0,l=0;a.navigator.userAgent;d.css("position","fixed"),h||b(function(){"left"==e.stay?h=d[0].getBoundingClientRect().top:"top"==e.stay&&(h=d[0].getBoundingClientRect().left)},5);var m=function(){if(g&&(b.cancel(g),g=null),i=this.pageXOffset,i!=j&&("left"==e.stay?("absolute"==d.css("position")&&(d.css("position","fixed"),d.css("top",h-k+"px"),d.css("left","0px")),e.stayTrack&&c.$eval(e.stayTrack+"("+i+")")):"top"==e.stay&&"fixed"==d.css("position")&&(d.css("position","absolute"),d.css("left",h+"px"),d.css("top",k+"px")),j=i),k=this.pageYOffset,k!=l&&("left"==e.stay?"fixed"==d.css("position")&&(d.css("position","absolute"),d.css("top",h+"px"),d.css("left",i+"px")):"top"==e.stay&&("absolute"==d.css("position")&&(d.css("position","fixed"),d.css("left",h-i+"px"),d.css("top","0px")),e.stayTrack&&c.$eval(e.stayTrack+"("+k+")")),l=k),e.stayRevertToFixed){var a=parseInt(e.stayRevertToFixed);a>0&&(g=b(f,a))}};angular.element(a).bind("scroll",m),d.on("$destroy",function(){b.cancel(f)}),c.$on("$destroy",function(){angular.element(a).unbind("scroll",m)})}}}]);var epgCalendar=angular.module("epgCalendar",[]);epgCalendar.controller("EpgCalController",["$scope","$timeout",function(a,b){a.minDate=new Date(a.guideData.zeroTime),a.maxDate=new Date(a.minDate.getTime()+12096e5),a.openCalendar=function(c){c.preventDefault(),c.stopPropagation(),a.calendarOpened?a.calendarOpened=!1:a.calendarOpened=!0,null!==a.popElem&&b(function(){a.popHide()},0)},a.$watch("calendarOpened",function(b){a.fireEpgAction(b?"open.calendar":"close.calendar")}),a.currentDate=function(b){if(b){var c=new Date(b);c.setMinutes(c.getMinutes()<30?0:30),c.setSeconds(0),c.setMilliseconds(0);var d=new Date(c);d.setHours(0),d.setMinutes(0),a.guideData.setStartTime(d),a.guideData.nextPage(null,c)}return a.guideData.curDate}}]);var epgSearch=angular.module("epgSearch",[]);epgSearch.controller("EpgSearchController",["$scope","$timeout","search",function(a,b,c){a.filterVal="",a.searchOpened=!1,a.searchClick=function(b){a.searchOpened=!a.searchOpened,a.fireEpgAction(a.searchOpened?"open.search":"close.search")},a.searchForward=function(){a.resultsSummary=null,c.forward(a.filterVal,a.guideData.curDate,a.showResult,a.guideData.mythlingServices)},a.searchBackward=function(){a.resultsSummary=null,c.backward(a.filterVal,a.guideData.curDate,a.showResult,a.guideData.mythlingServices)},a.showResult=function(b){if(a.resultsSummary=b.index+1+" / "+b.programs.length,b.programs.length>0){var c=b.programs[b.index],d=new Date(c.start);d.setMinutes(0),a.guideData.setStartTime(d),a.guideData.nextPage(c.id)}},a.isSearching=function(){return c.isBusy()},a.closeSearch=function(){b(function(){document.getElementById("searchBtn").click()},5)},a.searchFilter=function(b){if(b||""===b)a.filterVal=b;else{if(!a.guideData.isMyth28&&!a.guideData.mythlingServices)return"Requires MythTV 0.28 or Mythling Services";if(a.guideData.demoMode)return"Search not available in demo"}return a.filterVal}}]),epgSearch.factory("search",["$http","$q",function(a,b){function c(c,g,h,i){e=!0,f.index=-1,f.programs=[],d=c;var j=new Date,k=i?"/mythling/media.php?type=guide&":"/Guide/GetProgramList?";k+="StartTime="+j.toISOString(),epgDebug&&console.log("search base url: "+k);var l;l=i?{mythlingSearch:a.get(k+"&listingsSearch="+d)}:{personSearch:a.get(k+"&PersonFilter="+d),keywordSearch:a.get(k+"&KeywordFilter="+d)},b.all(l).then(function(a){if(e=!1,i?f.addPrograms(a.mythlingSearch.data.ProgramList.Programs):(f.addPrograms(a.personSearch.data.ProgramList.Programs),f.addPrograms(a.keywordSearch.data.ProgramList.Programs)),f.programs.length>0){f.index=0;var b=f.programs[f.index],c=new Date(g.getTime());for(c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0);b.start.getTime()<c.getTime();)f.index++,b=f.programs[f.index]}h(f)})}var d,e=!1,f={index:-1,programs:[],addPrograms:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.hasProgram(c)||(c.start=new Date(c.StartTime),c.id="ch"+c.Channel.ChanId+"pr"+c.StartTime,this.programs.push(c))}},hasProgram:function(a){for(var b=0;b<this.programs.length;b++){var c=this.programs[b];if(c.StartTime==a.StartTime&&c.Channel.ChanId==a.Channel.ChanId)return!0}return!1}};return{forward:function(a,b,e,g){if(a&&""!==a){var h=encodeURIComponent(a);h!=d&&c(h,b,e,g),f.programs.length>0&&(f.index++,f.index==f.programs.length&&(f.index=0),e(f))}},backward:function(a,b,e,g){if(a&&""!==a){var h=encodeURIComponent(a);h!=d&&c(h,b,e,g),f.programs.length>0&&(f.index--,-1==f.index&&(f.index=f.programs.length-1),e(f))}},isBusy:function(){return e},getResults:function(){return f}}}]),epgSearch.directive("searchPreRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){a(function(){c[0].click(),c[0].click()},5)}}}]);