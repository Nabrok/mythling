/*! mythling-epg v1.2.0
 *  Copyright 2015 Donald Oakes
 *  License: Apache-2.0 */
"use strict";function urlParams(){for(var a,b={},c=/([^&=]+)=?([^&]*)/g;null!==(a=c.exec(window.location.search.substring(1)));)b[decodeURIComponent(a[1])]=decodeURIComponent(a[2]);return b}function parseCssDim(a){return a.endsWith("px")&&(a=a.substring(0,a.lastIndexOf("px"))),parseInt(a)}var epgApp=angular.module("epgApp",["epgSearch","epgCalendar","infinite-scroll","stay","ui.bootstrap"]);epgApp.config(["$compileProvider",function(a){var b="true"==urlParams().angularDebug;a.debugInfoEnabled(b)}]),epgApp.config(["$httpProvider",function(a){a.defaults.headers.get={Accept:"application/json"}}]),epgApp.config(["$tooltipProvider",function(a){a.setTriggers({popShow:"popHide"})}]),epgApp.controller("EpgController",["$scope","$window","$http","$timeout","$location","$modal","$filter","GuideData",function(a,b,c,d,e,f,g,h){console.log("userAgent: "+b.navigator.userAgent),console.log("location: "+b.location);for(var i=0;i<b.document.styleSheets.length;i++){var j=b.document.styleSheets[i];if(null!==j.href&&j.href.endsWith("mythling.css"))for(var k=0;k<j.cssRules.length;k++){var l=j.cssRules[k];".slot-width"===l.selectorText?a.slotWidth=parseCssDim(l.style.width):".header-height"===l.selectorText?a.headerHeight=parseCssDim(l.style.height):".label-width"===l.selectorText?a.labelWidth=parseCssDim(l.style.width):".row-height"===l.selectorText&&(a.rowHeight=parseCssDim(l.style.height))}}var m=urlParams(),n=m.startTime?new Date(m.startTime):new Date;n=m.StartTime?new Date(m.StartTime):n,console.log("startTime: "+n);var o=m.guideInterval?parseInt(m.guideInterval):8,p=m.guideHistory?parseInt(m.guideHistory):0;a.bufferSize=m.bufferSize?parseInt(m.bufferSize):3;var q=m.awaitPrime?"true"==m.awaitPrime:!0,r=m.channelGroupId?parseInt(m.channelGroupId):0,s=m.mythlingServices?"true"==m.mythlingServices:!1,t=m.demoMode?"true"==m.demoMode:!1;a.guideData=new h(n,a.slotWidth,o,q,p,r,s,t),a.setPosition=function(b){var c=Math.floor(b/a.slotWidth),d=new Date(a.guideData.zeroTime.getTime()+18e5*c);if(d.getTime()!=a.guideData.curDate.getTime()&&(a.guideData.curDate=d,!a.guideData.busy)){var e=g("date")(a.guideData.curDate,"EEE MMM d");document.getElementById("calendarInput").value=e}},setPosition=a.setPosition,a.popElem=null,a.setPopElem=function(b){a.popElem=b},a.popHide=function(){null!==a.popElem&&(a.popElem.triggerHandler("popHide"),a.popElem=null)},a.popPlace="top",a.setPopPlace=function(b){a.popPlace=b};var u=angular.element(b);u.bind("click",a.popHide),u.bind("scroll",a.popHide),u.bind("resize",a.popHide),a.details=function(b){var d="/Guide/GetProgramDetails?ChanId="+b.channel.ChanId+"&StartTime="+b.StartTime;console.log("details url: "+d),c.get(d).success(function(c){var d=c.Program;if(d.Description&&(b.description=d.Description.replace("``",'"')),d.Airdate&&"true"===d.Repeat){var e=d.Airdate,g=new Date;g.setFullYear(parseInt(e.substring(0,e.indexOf("-")))),g.setMonth(parseInt(e.substring(e.indexOf("-")+1,e.lastIndexOf("-")))-1),g.setDate(parseInt(e.substring(e.lastIndexOf("-")+1))),g.setHours(0),g.setMinutes(0),g.setSeconds(0),g.setMilliseconds(0),b.originalAirDate=g}if(d.Category&&(b.category=d.Category),d.Season&&"0"!=d.Season&&(b.season=parseInt(d.Season)),d.Episode&&"0"!=d.Episode&&(b.episode=parseInt(d.Episode)),d.Stars&&"0"!=d.Stars&&(b.rating=Math.round(5*parseFloat(d.Stars))),d.Cast&&d.Cast.CastMembers){for(var h="",i="",j=0;j<d.Cast.CastMembers.length;j++){var k=d.Cast.CastMembers[j];"director"==k.Role?h+=k.Name+", ":("actor"==k.Role||"guest_star"==k.Role)&&(i+=k.Name+", ")}""!==h&&(b.directors=h.substring(0,h.length-2)),""!==i&&(b.actors=i.substring(0,i.length-2))}a.program=b;f.open({animation:!1,templateUrl:"views/details.html",controller:"EpgModalController",scope:a})})},a.fireEpgAction=function(a){"function"==typeof CustomEvent&&document.dispatchEvent(new CustomEvent("epgAction",{name:a}))},0===a.bufferSize&&a.guideData.nextPage()}]),epgApp.controller("EpgModalController",["$scope","$modalInstance",function(a,b){a.close=function(){b.dismiss("close")}}]),epgApp.directive("popClick",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){if(b.popElem!=c){var d=c[0].getBoundingClientRect(),e="top";d.top<document.documentElement.clientHeight-d.bottom&&(e="bottom"),d.left<100&&(e="right"),document.documentElement.clientWidth-d.right<100&&(e="left"),b.setPopPlace(e),b.$apply(),a(function(){null===b.popElem&&(c.triggerHandler("popShow"),b.setPopElem(c))},50)}})}}}]),epgApp.directive("onEnter",function(){return{restrict:"A",link:function(a,b,c){b.bind("keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.onEnter)}),b.preventDefault())})}}}),epgApp.directive("focusMe",function(){var a={};return{restrict:"A",link:function(b,c,d){"later"==d.focusMe?a[c[0].id]?c[0].focus():a[c[0].id]=!0:c[0].focus()}}}),epgApp.directive("blurMe",function(){return{restrict:"A",link:function(a,b,c){b.bind("focus",function(){b[0].blur()})}}}),epgApp.directive("epgRecord",["$http",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){var c=d.epgRecord,e="/Dvr/";"single"==c||"transcode"==c||"all"==c?e+="AddRecordSchedule?ChanId="+b.program.channel.ChanId+"&Station="+b.program.channel.CallSign+"&StartTime="+b.program.StartTime+"&EndTime="+b.program.EndTime+"&Type="+("transcode"==c?"single":c)+"&Title="+encodeURI(b.program.Title)+"&FindDay=0&FindTime=00:00:00":("dont"==c||"never"==c)&&(e+="AddDontRecordSchedule?ChanId="+b.program.channel.ChanId+"&StartTime="+b.program.StartTime+"&NeverRecord="+("never"==c)),"transcode"==c&&(e+="&AutoTranscode=true"),b.fireEpgAction("record"),console.log("record action url: "+e),a.post(e).success(function(a,d,e,f){b.program.willRecord="single"==c||"transcode"==c||"all"==c})})}}}]),epgApp.factory("GuideData",["$http","$timeout","$window","$filter",function(a,b,c,d){var e=function(a,b,c,d,e,f,g,h){this.slotWidth=b,this.interval=36e5*c,this.history=36e5*e,f&&(this.channelGroupId=f),this.busy=!1,this.prescrolled=!1,this.preventMobileScroll=function(a){a.preventDefault()},this.setStartTime(a),this.awaitPrime=d,this.mythlingServices=g,this.demoMode=h};return e.prototype.setStartTime=function(a){console.log("startTime: "+a.toISOString()),this.awaitPrime=!1,this.curDate=new Date(a),this.channels={},this.startTime=new Date(a),this.startTime.setTime(this.startTime.getTime()-this.history),this.startTime.setMinutes(this.startTime.getMinutes()>=30?30:0),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0),this.endTime=new Date(this.startTime.getTime()+this.interval),this.zeroTime=new Date(this.startTime),this.midnight=new Date(this.zeroTime.getTime()+864e5),this.midnight.setHours(0),this.midnight.setMinutes(0),this.tomorrow=new Date(this.midnight.getTime()+864e5),this.timeslots=[],this.index=10},e.prototype.nextPage=function(e){if(!this.busy){this.busy=!0;for(var f=this.startTime.toISOString(),g=this.endTime.toISOString(),h=this.startTime.getTime();h<this.endTime.getTime();h+=18e5){var i=new Date(h),j=i.getHours(),k=j>=12?" pm":" am";0===j?j=12:j>12&&(j-=12),k=j+":"+(0===i.getMinutes()?"00":"30")+k,this.timeslots.push(k)}var l;l=this.demoMode?"demo/guide-data/":this.mythlingServices?"/mythling/media.php?type=guide&":"/Guide/GetProgramGuide?";var m="StartTime="+f+"&EndTime="+g;if(this.channelGroupId&&this.channelGroupId>0&&(m+="&ChannelGroupId="+this.channelGroupId),l+=this.demoMode?m.replace(/:/g,"-")+".json":m,console.log("retrieving from: "+l),this.awaitPrime&&angular.element(document.body).bind("touchmove",this.preventMobileScroll),document.getElementById("calendarInput").value="Loading...",b(function(){document.getElementById("calendarInput").value="Loading..."},5),this.awaitPrime){var n=document.getElementById("calendarInput");angular.element(n).addClass("input-warn")}a.get(l).success(function(a){"undefined"==typeof this.isMyth28&&(this.mythVersion=a.ProgramGuide.Version?a.ProgramGuide.Version:"0.27",console.log("MythTV version "+this.mythVersion),this.isMyth28=!this.mythVersion.startsWith("0.27"));for(var f=a.ProgramGuide.Channels,g=0,h=0;h<f.length;h++){var i=f[h];if(i.Programs.length>0){g++;for(var j=i.ChanNum;j.length<4;)j="0"+j;j in this.channels||(i.programs={},i.progSize=0,i.progOffset=0,this.channels[j]=i);for(var k=this.channels[j],l=0;l<i.Programs.length;l++){var m=i.Programs[l],n=new Date(m.EndTime);if(n.getTime()>this.startTime.getTime()-this.history){var o=m.StartTime;if(!(o in k.programs)){k.programs[o]=m,k.progSize++;var p=new Date(m.StartTime),q=p.getTime()<this.startTime.getTime()?this.startTime.getTime():p.getTime(),r=(n.getTime()-q)/18e5;m.start=p,m.end=n,m.offset=k.progOffset,m.width=Math.round(this.slotWidth*r),m.subTitle=m.SubTitle?'"'+m.SubTitle+'"':"",m.willRecord="-1"==m.Recording.Status||"-2"==m.Recording.Status||"-3"==m.Recording.Status||"WillRecord"==m.Recording.Status||"Recording"==m.Recording.Status||"Recorded"==m.Recording.Status,m.channel=k,m.id="ch"+k.ChanId+"pr"+m.StartTime,m.seq="ch"+g+"pr"+k.progSize,m.index=this.index++,k.progOffset+=m.width}}}}}if(this.startTime.setTime(this.endTime.getTime()),this.endTime.setTime(this.endTime.getTime()+this.interval),!this.prescrolled){this.prescrolled=!0;var s=this.history*this.slotWidth/18e5;b(function(){c.scrollBy(s,0)},50)}if(e&&b(function(){console.log("selecting program: "+e),document.getElementById(e).focus()},75),this.awaitPrime){var t=this.preventMobileScroll;b(function(){angular.element(document.body).unbind("touchmove",t)},5)}var u=document.getElementById("calendarInput");angular.element(u).removeClass("input-warn"),u.value=d("date")(this.curDate,"EEE MMM d"),this.busy=!1}.bind(this))}},e}]);var setPosition;"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)});var stayMod=angular.module("stay",[]);stayMod.directive("stay",["$window","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){function f(){"absolute"==d.css("position")&&("left"==e.stay?(d.css("position","fixed"),d.css("top",h-k+"px"),d.css("left","0px")):"top"==e.stay&&(d.css("position","fixed"),d.css("left",h-i+"px"),d.css("top","0px")))}var g,h,i=0,j=0,k=0,l=0;a.navigator.userAgent;d.css("position","fixed"),h||b(function(){"left"==e.stay?h=d[0].getBoundingClientRect().top:"top"==e.stay&&(h=d[0].getBoundingClientRect().left)},5);var m=function(){g&&(b.cancel(g),g=null),i=this.pageXOffset,i!=j&&("left"==e.stay?("absolute"==d.css("position")&&(d.css("position","fixed"),d.css("top",h-k+"px"),d.css("left","0px")),e.stayTrack&&c.$eval(e.stayTrack+"("+i+")")):"top"==e.stay&&"fixed"==d.css("position")&&(d.css("position","absolute"),d.css("left",h+"px"),d.css("top",k+"px")),j=i),k=this.pageYOffset,k!=l&&("left"==e.stay?"fixed"==d.css("position")&&(d.css("position","absolute"),d.css("top",h+"px"),d.css("left",i+"px")):"top"==e.stay&&("absolute"==d.css("position")&&(d.css("position","fixed"),d.css("left",h-i+"px"),d.css("top","0px")),e.stayTrack&&c.$eval(e.stayTrack+"("+k+")")),l=k),e.stayRevertToFixed&&(g=b(f,parseInt(e.stayRevertToFixed)))};angular.element(a).bind("scroll",m),d.on("$destroy",function(){b.cancel(f)}),c.$on("$destroy",function(){angular.element(a).unbind("scroll",m)})}}}]);var epgCalendar=angular.module("epgCalendar",[]);epgCalendar.controller("EpgCalController",["$scope","$http",function(a,b){a.minDate=new Date,a.maxDate=new Date(a.minDate.getTime()+12096e5),a.openCalendar=function(b){b.preventDefault(),b.stopPropagation(),a.calendarOpened?a.calendarOpened=!1:a.calendarOpened=!0},a.currentDate=function(b){return b&&(b.setHours(0),b.setMinutes(0),a.guideData.setStartTime(b),a.fireEpgAction("calendar"),a.guideData.nextPage()),a.guideData.curDate}}]);var epgSearch=angular.module("epgSearch",[]);epgSearch.controller("EpgSearchController",["$scope","$timeout","search",function(a,b,c){a.filterVal="",a.searchOpened=!1,a.searchClick=function(b){a.searchOpened=!a.searchOpened},a.searchForward=function(){a.resultsSummary=null,c.forward(a.filterVal,a.guideData.curDate,a.showResult)},a.searchBackward=function(){a.resultsSummary=null,c.backward(a.filterVal,a.guideData.curDate,a.showResult)},a.showResult=function(b){if(a.resultsSummary=b.index+1+" / "+b.programs.length,b.programs.length>0){var c=b.programs[b.index],d=new Date(c.start);d.setMinutes(0),a.guideData.setStartTime(d),a.guideData.nextPage(c.id)}},a.isSearching=function(){return c.isBusy()},a.closeSearch=function(){b(function(){a.fireEpgAction("search"),document.getElementById("searchBtn").click()},5)},a.searchFilter=function(b){if(b||""===b)a.filterVal=b;else if(!a.guideData.isMyth28)return"Search requires MythTV 0.28";return a.filterVal}}]),epgSearch.factory("search",["$http","$q",function(a,b){function c(c,g,h){e=!0,f.index=-1,f.programs=[],d=c;var i=new Date,j="/Guide/GetProgramList?StartTime="+i.toISOString();console.log("search base url: "+j),b.all({personSearch:a.get(j+"&PersonFilter="+d),keywordSearch:a.get(j+"&KeywordFilter="+d)}).then(function(a){if(e=!1,f.addPrograms(a.personSearch.data.ProgramList.Programs),f.addPrograms(a.keywordSearch.data.ProgramList.Programs),f.programs.length>0){f.index=0;var b=f.programs[f.index],c=new Date(g.getTime());for(c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0);b.start.getTime()<c.getTime();)f.index++,b=f.programs[f.index]}h(f)})}var d,e=!1,f={index:-1,programs:[],addPrograms:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.hasProgram(c)||(c.start=new Date(c.StartTime),c.id="ch"+c.Channel.ChanId+"pr"+c.StartTime,this.programs.push(c))}},hasProgram:function(a){for(var b=0;b<this.programs.length;b++){var c=this.programs[b];if(c.ChanId==a.ChanId&&c.StartTime==a.StartTime)return!0}}};return{forward:function(a,b,e){if(a&&""!==a){var g=encodeURIComponent(a);g!=d&&c(g,b,e),f.programs.length>0&&(f.index++,f.index==f.programs.length&&(f.index=0),e(f))}},backward:function(a,b,e){if(a&&""!==a){var g=encodeURIComponent(a);g!=d&&c(g,b,e),f.programs.length>0&&(f.index--,-1==f.index&&(f.index=f.programs.length-1),e(f))}},isBusy:function(){return e},getResults:function(){return f}}}]),epgSearch.directive("searchPreRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){a(function(){c[0].click(),c[0].click()},5)}}}]);